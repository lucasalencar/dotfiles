#!/bin/bash

source "$DOTFILES_ROOT/helpers"

update_package() {
  local package=$1

  if [ -f "$DOTFILES_ROOT/$package/update" ]; then
    info "Updating $package"
    "$DOTFILES_ROOT/$package/update"
  else
    warning "No update script found for package: $package"
  fi
}

update_profile_packages() {
  local profile=$1

  info "Updating packages for $profile profile"

  "$DOTFILES_ROOT/bundle" "$profile"

  while read -r package; do
    update_package "$package"
  done < "$DOTFILES_ROOT/profiles/$profile"
  unset package

  success "$profile profile packages update completed"
}

# If arguments are provided, update only those packages
if [ $# -gt 0 ]; then
  info "Updating specified packages"
  for package in "$@"; do
    update_package "$package"
  done
  success "Update completed"
else
  # No arguments: update everything (default behavior)
  sudo -v # Ask for sudo password once

  # Keep sudo privileges alive in background
  # This prevents password prompts during long-running operations like Homebrew cask updates
  while true; do
    sudo -n true
    sleep 60
    kill -0 "$$" || exit
  done 2>/dev/null &
  SUDO_KEEPALIVE_PID=$!

  # Cleanup function to stop sudo keepalive process
  cleanup() {
    kill "$SUDO_KEEPALIVE_PID" 2>/dev/null
  }

  # Handle script exit: always cleanup keepalive process
  trap cleanup EXIT

  # Handle Ctrl+C: show message and exit (cleanup runs automatically via EXIT trap)
  trap 'echo ""; warning "Update interrupted by user"; exit 130' INT TERM

  info "Updating dotfiles project"
  git -C "$HOME/.dotfiles" pull --rebase

  update_package "homebrew"
  update_profile_packages "basic"

  [ -n "$(current_profile)" ] && update_profile_packages "$(current_profile)"

  success "Update completed"
fi
